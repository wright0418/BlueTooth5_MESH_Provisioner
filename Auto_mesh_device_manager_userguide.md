# RL Mesh 自動/手動設備管理器 (Auto_mesh_device_manager.py) 使用手冊

## 1. 簡介

`Auto_mesh_device_manager.py` 是一個 Python 腳本，用於管理基於 RL62M02 模組的藍牙 Mesh 網路中的設備。它提供了一個命令列介面，讓使用者可以：

*   **手動綁定** 新的 Mesh 設備。
*   **解除所有** 已綁定設備的綁定。
*   從設定檔 (`My_device.json`) **自動綁定** 設備。
*   **顯示** 目前所有已綁定的設備列表。

此工具旨在簡化 Mesh 設備的配置和管理流程，特別是在需要重複部署或管理多個設備的場景中。

## 2. 環境要求

*   **Python**: 需要安裝 Python 3.x 版本。
*   **rl62m02 函式庫**: 需要安裝 `rl62m02` Python 函式庫。如果尚未安裝，請參考該函式庫的安裝說明。
*   **RL62M02 Provisioner**: 需要一個已連接到電腦並正確配置為 Provisioner 角色的 RL62M02 硬體模組。
*   **序列埠驅動程式**: 確保電腦已安裝 RL62M02 模組對應的 USB 轉序列埠驅動程式 (例如 CP210x)。

## 3. 如何執行

在命令列或終端機中，使用以下語法執行腳本：

```bash
python Auto_mesh_device_manager.py <COM埠> [--debug]
```

*   `<COM埠>`: **必需參數**。指定 RL62M02 Provisioner 連接的序列埠名稱 (例如 `COM3` 或 `/dev/ttyUSB0`)。
*   `--debug`: **可選參數**。啟用詳細的除錯日誌輸出，有助於排查問題。

**範例:**

```bash
# 在 Windows 上使用 COM3
python Auto_mesh_device_manager.py COM3

# 在 Linux 上使用 ttyUSB0 並啟用除錯模式
python Auto_mesh_device_manager.py /dev/ttyUSB0 --debug
```

成功執行後，腳本會嘗試初始化 Provisioner，並顯示主選單。

## 4. 主選單功能

腳本啟動後會顯示以下主選單：

```
===== RL Mesh 自動/手動設備管理器 (My_device.json) =====
1. 手動綁定設備
2. 解除所有設備綁定
3. 從檔案自動綁定設備
4. 顯示所有已綁定設備
0. 離開
請選擇操作:
```

以下是各選項的詳細說明：

### 選項 1: 手動綁定設備

此選項允許您掃描周圍未被綁定的 Mesh 設備，並手動將其加入網路。

1.  **掃描設備**: 腳本會掃描幾秒鐘以尋找附近的 Mesh 設備。
2.  **選擇設備**: 顯示掃描到的設備列表 (UUID 和 MAC 地址)，請輸入要綁定的設備編號。
3.  **輸入設備資訊**:
    *   **設備類型**: 選擇預定義的類型 (RGB LED, 插座等) 或輸入自定義類型。
    *   **設備名稱**: 輸入一個易於識別的名稱 (必填)。
    *   **設備位置**: 輸入設備的物理位置 (可選)。
4.  **執行綁定**: 腳本會嘗試將設備綁定到 Provisioner。成功後會顯示分配給該設備的單播地址 (UID)。
5.  **設定通道 (可選)**:
    *   **訂閱通道**: 輸入一個 Group Address (例如 `0xC000`)，讓設備監聽此地址的訊息。留空則跳過。
    *   **推撥通道**: 輸入一個 Group Address (例如 `0xC001`)，讓設備將狀態更新發送到此地址。留空則跳過。
6.  **儲存資訊**: 綁定成功後，設備的資訊 (名稱、類型、位置、MAC、UID) 會自動儲存到 `My_device.json` 檔案中。

### 選項 2: 解除所有設備綁定

此選項會將 Provisioner 網路中的所有設備解除綁定。

1.  **確認**: 腳本會顯示目前已綁定的設備數量，並要求確認是否繼續。輸入 `y` 確認，其他則取消。
2.  **逐一解除**: 腳本會嘗試逐一向每個設備發送解除綁定命令。
3.  **儲存選項**: 詢問是否在解除綁定 *每個* 設備後立即更新 `My_device.json` 檔案。
    *   `y`: 每次成功解除綁定後都儲存。
    *   `n`: 等待所有設備嘗試解除綁定完成後才儲存 (如果選擇不清除檔案)。
4.  **強制移除**: 如果設備無響應導致解除綁定命令失敗，腳本仍會將其資訊從 `My_device.json` 中移除 (如果選擇不清除檔案)。
5.  **清除檔案**: 最後詢問是否要完全清空 `My_device.json` 檔案。輸入 `y` 會刪除所有設備記錄，`n` 則保留 (可能包含解除綁定失敗的設備記錄，除非之前選擇了強制移除)。

**注意**: 解除綁定操作會重置設備，使其恢復到未配置狀態。

### 選項 3: 從檔案自動綁定設備

此選項用於根據 `My_device.json` 檔案中的記錄，自動重新綁定所有設備。這在需要快速恢復網路配置或將配置應用到新的 Provisioner 時非常有用。

1.  **清除現有綁定 (嘗試)**: 腳本會嘗試重置 Provisioner 上的 Mesh 網路設定 (如果函式庫支援)。**警告**: 這可能導致 UID 從 `0x0100` 重新開始分配，與 `My_device.json` 中記錄的舊 UID 不同。
2.  **載入設定檔**: 從 `My_device.json` 讀取設備列表。
3.  **掃描設備**: 掃描周邊設備，以獲取它們當前的 UUID (因為設備重置後 UUID 可能改變)。
4.  **匹配與綁定**:
    *   遍歷 `My_device.json` 中的每個設備記錄。
    *   使用記錄中的 MAC 地址在掃描結果中查找對應的 UUID。
    *   如果找到 UUID，則使用 `My_device.json` 中的名稱、類型、位置等資訊，以及掃描到的 UUID，嘗試重新綁定該設備。
    *   綁定過程會自動重試最多 3 次。
5.  **儲存資訊**: 每次成功綁定後，新的 UID 會自動更新到 `My_device.json` 中對應的設備記錄。
6.  **結果總結**: 顯示成功和失敗綁定的設備數量及列表。

**重要**:
*   此功能依賴 `My_device.json` 檔案中正確的 MAC 地址。
*   執行此功能前，請確保所有需要綁定的設備都已上電並處於可被發現狀態。
*   由於綁定過程會重新分配 UID，設備原有的 UID 將會改變。

### 選項 4: 顯示所有已綁定設備

此選項會讀取 `My_device.json` 檔案，並以表格形式列出所有已記錄 (理論上是已綁定) 的設備資訊，包括：

*   編號
*   名稱 (來自 `devType` 欄位)
*   類型 (來自 `devName` 欄位)
*   UID (單播地址)
*   MAC 地址
*   位置
*   狀態 (基於 `state` 欄位，如果存在)

### 選項 0: 離開

退出腳本並關閉與 Provisioner 的序列埠連接。

## 5. 設定檔 (`My_device.json`)

`My_device.json` 是此工具用來儲存 Mesh 網路配置的核心檔案。它是一個 JSON 格式的檔案，包含以下主要結構：

```json
{
  "gwMac": "AA:BB:CC:DD:EE:FF", // Provisioner 的 MAC 地址
  "devices": [
    {
      "uid": "0x0100",           // 設備的單播地址 (十六進位字串)
      "devMac": "11:22:33:44:55:66", // 設備的 MAC 地址
      "devType": "客廳燈",       // 設備名稱 (手動輸入)
      "devName": "RGB_LED",      // 設備類型 (選擇或自定義)
      "position": "客廳天花板", // 設備位置 (手動輸入)
      "state": 1               // 設備狀態 (可能由其他程式更新, 1=開, 0=關)
    },
    {
      // ... 其他設備 ...
    }
  ]
}
```

*   `gwMac`: Provisioner (閘道器) 的 MAC 地址。腳本啟動時會嘗試讀取並更新此欄位。
*   `devices`: 一個包含所有已綁定設備資訊的列表。
    *   `uid`: 設備在 Mesh 網路中的唯一地址。
    *   `devMac`: 設備的藍牙 MAC 地址，用於在自動綁定時識別設備。
    *   `devType`: 使用者定義的設備名稱。
    *   `devName`: 設備的類型。
    *   `position`: 使用者定義的設備位置。
    *   `state`: (可選) 表示設備的開關狀態或其他狀態。

**注意**:
*   手動綁定和自動綁定成功後，此檔案會被自動更新。
*   解除綁定操作也會修改此檔案 (移除設備或清空)。
*   建議定期備份此檔案。

## 6. 疑難排解

*   **無法初始化 Provisioner**:
    *   檢查 COM 埠號是否正確。
    *   確認 RL62M02 模組已正確連接並上電。
    *   確保模組已燒錄 Provisioner 韌體並配置為 Provisioner 角色。
    *   檢查是否有其他程式佔用了該 COM 埠。
*   **掃描不到設備**:
    *   確認目標設備已上電並處於未配置 (unprovisioned) 或可被發現狀態。
    *   嘗試將設備靠近 Provisioner。
    *   增加掃描時間 (可能需要修改腳本)。
*   **綁定失敗**:
    *   可能是訊號干擾或距離太遠。
    *   設備可能已被其他 Provisioner 綁定。
    *   檢查腳本的除錯輸出 (`--debug`) 以獲取更多錯誤資訊。
*   **自動綁定失敗**:
    *   確認 `My_device.json` 中的 MAC 地址是否正確。
    *   確認所有設備都已上電。
    *   檢查掃描結果，看是否能找到對應 MAC 地址的設備。
*   **JSON 檔案錯誤**:
    *   如果提示 JSON 格式錯誤，請檢查 `My_device.json` 檔案內容是否符合 JSON 語法。可以嘗試使用 JSON 驗證工具檢查。

---
